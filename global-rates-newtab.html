<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Global Key Interest Rates â€” New Tab</title>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 16px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
      Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: #ffffff; color: #111827;
    }
    .widget {
      width: 100%; max-width: 960px; margin: 0 auto;
      border: 1px solid #e5e7eb; border-radius: 16px; padding: 12px 12px 8px 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.04);
    }
    .title {
      font-weight: 700; font-size: 16px; letter-spacing: 0.2px; margin: 0 0 8px 0;
      display: flex; align-items: center; gap: 8px;
    }
    .title small { font-weight: 500; color: #6b7280; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 8px; text-align: left; font-size: 14px; }
    thead th { font-weight: 700; color: #374151; border-bottom: 1px solid #e5e7eb; }
    tbody tr { border-bottom: 1px dashed #e5e7eb; }
    tbody tr:last-child { border-bottom: 0; }
    .rate { font-variant-numeric: tabular-nums; font-weight: 700; }
    .pill {
      display: inline-flex; align-items: center; gap: 6px; padding: 2px 8px; border-radius: 999px;
      background: #f3f4f6; color: #111827; font-size: 12px; border: 1px solid #e5e7eb;
    }
    .flag { font-size: 16px; }
    .cb { color: #111827; text-decoration: none; }
    .cb:hover { text-decoration: underline; }
    .trend { font-weight: 700; }
    .up { color: #DC2626; }     /* red */
    .down { color: #16A34A; }   /* green */
    .flat { color: #6B7280; }   /* gray */
    .footer { margin-top: 8px; color: #6b7280; font-size: 12px; display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;}
    .source { font-size: 12px; color: #6b7280; }
    .controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .badge { border:1px solid #e5e7eb; padding:2px 6px; border-radius:8px; background:#f9fafb;}
    .hidden { display:none; }
    /* Inline panel for Version B */
    .panel {
      margin-top: 8px; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden;
      height: 520px;
    }
    .panel iframe { width: 100%; height: 100%; border: 0; }
    .rowlink { cursor: pointer; }
  </style>

</head>
<body>
  <div class="widget">
    <h1 class="title">Global Key Interest Rates <small>(auto-updates daily)</small></h1>
    <table>
      <thead>
        <tr>
          <th>Economy</th>
          <th>Central Bank</th>
          <th>Rate</th>
          <th>Trend</th>
          <th>Detail</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="footer">
      <div class="controls">
        <span class="badge">Mode: New Tab</span>
        <span class="badge">Hover a row to see last moves</span>
      </div>
      <div class="source">Data: API Ninjas (policy rates), official charts on click. â€¢ Last refreshed: <span id="updated">2025-08-30</span></div>
    </div>
  </div>

<script>
// ======== CONFIGURATION ========
// Provide your API Ninjas key (https://api-ninjas.com/api/interestrate)
const API_NINJAS_KEY = 'kgI3F0Es39+JkHbdzuweyg==gs7ZqdKRohIyAM9H';

// Choose mode via query string: ?mode=newtab or ?mode=inline
const MODE = (new URLSearchParams(location.search).get('mode') || 'newtab').toLowerCase();

// Countries & exact policy rates to display
// API returns a set of rates per country; we'll choose the relevant policy rate field
// and fall back gracefully if a field is missing.
const ENTRIES = [
  { flag: 'ðŸ‡ºðŸ‡¸', country: 'United States', bank: 'Federal Reserve',       key: 'central_bank_rate', alias: 'Fed Funds (Upper Bound)',   chart: 'https://fred.stlouisfed.org/series/FEDFUNDS' },
  { flag: 'ðŸ‡ªðŸ‡º', country: 'Eurozone',      bank: 'European Central Bank', key: 'refinancing_rate',  alias: 'Main Refinancing Rate',    chart: 'https://data.ecb.europa.eu/main-figures/ecb-interest-rates-and-exchange-rates/key-ecb-interest-rates' },
  { flag: 'ðŸ‡¬ðŸ‡§', country: 'United Kingdom', bank: 'Bank of England',      key: 'central_bank_rate', alias: 'Bank Rate',                 chart: 'https://www.bankofengland.co.uk/boeapps/database/Bank-Rate.asp' },
  { flag: 'ðŸ‡¯ðŸ‡µ', country: 'Japan',         bank: 'Bank of Japan',         key: 'central_bank_rate', alias: 'Policy Rate Balance',       chart: 'https://www.boj.or.jp/en/statistics/boj/other/ff/index.htm' },
  { flag: 'ðŸ‡¨ðŸ‡³', country: 'China',         bank: 'PBoC',                  key: 'lpr_1y',            alias: '1-Year Loan Prime Rate',    chart: 'https://www.chinamoney.com.cn/english/lpr/' },
  { flag: 'ðŸ‡¨ðŸ‡­', country: 'Switzerland',   bank: 'Swiss National Bank',   key: 'central_bank_rate', alias: 'SNB Policy Rate',           chart: 'https://www.snb.ch/en/the-snb/mandates-goals/statistics/statistics-pub/current_interest_exchange_rates' },
];

// Map API-Ninjas field names for consistency
function selectRate(data, desiredKey) {
  // API Ninjas returns fields like central_bank_rate, refinancing_rate, etc.
  const candidates = [
    desiredKey,
    'central_bank_rate',
    'refinancing_rate',
    'bank_rate',
    'policy_rate',
    'interest_rate',
    'main_rate',
    'lpr_1y',
    'lpr',
  ];
  for (const k of candidates) {
    if (data[k] != null) return Number(data[k]);
  }
  return null;
}

// Trend arrows with colors
function trendSymbol(delta) {
  if (delta == null) return '<span class="trend flat">â†’</span>';
  if (delta > 0) return '<span class="trend up">â†‘</span>';
  if (delta < 0) return '<span class="trend down">â†“</span>';
  return '<span class="trend flat">â†’</span>';
}

// Fetch current + historical (last few moves) from API Ninjas
async function fetchCountry(country) {
  const headers = { 'X-Api-Key': API_NINJAS_KEY };
  const currentUrl = `https://api.api-ninjas.com/v1/interestrate?country=${encodeURIComponent(country)}`;
  const histUrl    = `https://api.api-ninjas.com/v1/interestratehistorical?country=${encodeURIComponent(country)}`;

  const [curRes, histRes] = await Promise.all([
    fetch(currentUrl, { headers }),
    fetch(histUrl, { headers }),
  ]);

  if (!curRes.ok) throw new Error(`Failed current for ${country}: ${curRes.status}`);
  if (!histRes.ok) throw new Error(`Failed historical for ${country}: ${histRes.status}`);

  const cur = await curRes.json();
  const hist = await histRes.json();
  return { cur, hist };
}

function formatPct(x) {
  if (x == null || isNaN(x)) return 'â€”';
  return (Math.round(x * 100) / 100).toFixed(2) + '%';
}

function computeMoves(series, key) {
  // series is array of {date, ...rates}
  // sort by date ascending and compute last 4 distinct values for the chosen key
  const parsed = (series || []).map(d => ({ date: new Date(d.date), val: (d[key] ?? d.central_bank_rate ?? d.refinancing_rate ?? d.lpr_1y ?? d.bank_rate) }))
                               .filter(d => d.val != null)
                               .sort((a,b)=>a.date-b.date);
  if (parsed.length === 0) return { last: null, delta: null, moves: [] };
  // Take last distinct changes
  const moves = [];
  let prev = null;
  for (const p of parsed) {
    if (prev == null || Number(p.val) !== Number(prev)) {
      moves.push({ date: p.date, val: Number(p.val) });
      prev = Number(p.val);
    }
  }
  // Keep last up to 4
  const lastMoves = moves.slice(-4);
  const last = lastMoves[lastMoves.length-1]?.val ?? null;
  const prevLast = lastMoves[lastMoves.length-2]?.val ?? null;
  const delta = (last!=null && prevLast!=null) ? last - prevLast : null;
  return { last, delta, moves: lastMoves };
}

function movesTooltip(moves) {
  if (!moves || moves.length === 0) return 'No recent changes';
  const parts = moves.map(m => `${m.date.toISOString().slice(0,10)}: ${formatPct(m.val)}`);
  return parts.join('\n');
}

async function render() {
  const tbody = document.querySelector('tbody');
  const updated = new Date();
  document.getElementById('updated').textContent = updated.toISOString().slice(0,10);

  for (const e of ENTRIES) {
    const row = document.createElement('tr');
    row.className = 'rowlink';
    row.dataset.chart = e.chart;

    const flag = document.createElement('td');
    flag.innerHTML = `<span class="flag">${e.flag}</span>`;

    const cb = document.createElement('td');
    cb.innerHTML = `<a class="cb" href="${e.chart}" target="${MODE==='newtab' ? '_blank' : '_self'}" rel="noopener">${e.bank}</a>`;

    const rate = document.createElement('td');
    rate.className = 'rate';
    rate.textContent = 'â€¦';

    const trend = document.createElement('td');
    trend.innerHTML = '<span class="trend flat">â†’</span>';

    const last = document.createElement('td');
    last.innerHTML = `<span class="pill">${e.alias}</span>`;

    row.append(flag, cb, rate, trend, last);
    tbody.appendChild(row);

    try {
      const { cur, hist } = await fetchCountry(e.country);
      const dataObj = Array.isArray(cur) ? cur[0] : cur; // API returns an array
      const v = selectRate(dataObj, e.key);
      const { last: lastVal, delta, moves } = computeMoves(hist, e.key);
      // Prefer lastVal from history if present; else v from current
      const display = (lastVal != null) ? lastVal : v;
      rate.textContent = formatPct(display);
      trend.innerHTML = trendSymbol(delta);
      row.title = movesTooltip(moves);

      // Click behavior for inline mode
      if (MODE === 'inline') {
        row.addEventListener('click', (ev) => {
          ev.preventDefault();
          document.getElementById('panel').classList.remove('hidden');
          document.getElementById('iframe').src = e.chart;
          // highlight selected
          document.querySelectorAll('tbody tr').forEach(tr=>tr.style.background='transparent');
          row.style.background = '#f9fafb';
        });
      } else {
        // new tab click on entire row
        row.addEventListener('click', () => window.open(e.chart, '_blank', 'noopener'));
      }
    } catch (err) {
      rate.textContent = 'â€”';
      trend.innerHTML = '<span class="trend flat">â†’</span>';
      row.title = 'Failed to load (check API key / network)';
      console.error(err);
    }
  }
}
document.addEventListener('DOMContentLoaded', render);
</script>

<script>
  // Force newtab mode just in case
  window.history.replaceState(null, '', window.location.pathname + '?mode=newtab');
</script>
</body>
</html>
